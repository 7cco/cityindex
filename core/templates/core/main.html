{% extends "base.html" %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">–§–∏–ª—å—Ç—Ä—ã</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                {{ form.region.label_tag }}
                {{ form.region }}
                {% if form.region.errors %}<div class="text-danger">{{ form.region.errors }}</div>{% endif %}
            </div>
            <div class="col-md-3">
                {{ form.population_min.label_tag }}
                {{ form.population_min }}
                {% if form.population_min.errors %}<div class="text-danger">{{ form.population_min.errors }}</div>{% endif %}
            </div>
            <div class="col-md-3">
                {{ form.population_max.label_tag }}
                {{ form.population_max }}
                {% if form.population_max.errors %}<div class="text-danger">{{ form.population_max.errors }}</div>{% endif %}
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </form>
        {% if request.GET %}
        <div class="mt-3">
            <a href="{% url 'main' %}" class="btn btn-outline-secondary btn-sm">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤</h5>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'compare' %}">
            {% csrf_token %}
            <div class="row">
                {% for city in all_cities %}
            <div class="col">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                        name="cities" value="{{ city.id }}" id="city_{{ city.id }}">
                    <label for="city_{{ city.id }}">
                        {{city.city}}
                    </label>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if all_cities %}
        <button type="submit" class="btn btn-success mt-2">
            <i class="fas fa-chart-bar"></i>–°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
        </button>
        {% endif %}
        </form>
    </div>
</div>

<!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ —Ç–∞–±–ª–∏—Ü—ã ... -->

{% if all_cities %}
  <!-- –¢–æ–ø-20 (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω) -->
  <div id="top-list">
    <h5>–¢–æ–ø-20 –≥–æ—Ä–æ–¥–æ–≤</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th>–ì–æ—Ä–æ–¥</th>
            <th>–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th>
            <th>–ù–î–§–õ(—Ç—ã—Å ‚ÇΩ)</th>
            <th>–®–∫–æ–ª—ã</th>
            <th>–ê–ó–°</th>
            <th>–û—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
            <th>–ò–Ω–¥–µ–∫—Å</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody>
          {% for city in top_20 %}
            <tr class="
              {% if city.cached_index >= 0.9 %}index-high
              {% elif city.cached_index >= 0.6 %}index-medium
              {% else %}index-low{% endif %}">
              <td><strong>{{ city.city }}</strong><br><small>{{ city.region }}</small></td>
              <td>{{ city.population }}</td>
              <td>
                {% if city.economics.exists %}
                  {% with eco=city.economics.first %}
                    {{ eco.ndfl_total|floatformat:0 }}
                    {% if eco.unemployment_rate %}({{ eco.unemployment_rate }}% –±–µ–∑—Ä–∞–±.){% endif %}
                  {% endwith %}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.schools }}{% else %}‚Äî{% endif %}</td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.gas_stations }}{% else %}‚Äî{% endif %}</td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.bus_stops }}{% else %}‚Äî{% endif %}</td>
              <td class="fw-bold">{{ city.cached_index|floatformat:2 }}</td>
              <td>
                {% if city.cached_index >= 0.9 %}
                  <span class="badge bg-success">–í—ã—Å–æ–∫–∏–π</span>
                {% elif city.cached_index >= 0.6 %}
                  <span class="badge bg-warning text-dark">–°—Ä–µ–¥–Ω–∏–π</span>
                {% else %}
                  <span class="badge bg-danger">–ù–∏–∑–∫–∏–π</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
  <div id="full-list" style="display: none;">
    <h5>–í—Å–µ –≥–æ—Ä–æ–¥–∞ ({{ all_cities|length }})</h5>
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th>–ì–æ—Ä–æ–¥</th>
            <th>–ù–∞—Å–µ–ª–µ–Ω–∏–µ</th>
            <th>–ù–î–§–õ(—Ç—ã—Å ‚ÇΩ)</th>
            <th>–®–∫–æ–ª—ã</th>
            <th>–ê–ó–°</th>
            <th>–û—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
            <th>–ò–Ω–¥–µ–∫—Å</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody>
          {% for city in all_cities %}
            <tr class="
              {% if city.cached_index >= 0.9 %}index-high
              {% elif city.cached_index >= 0.6 %}index-medium
              {% else %}index-low{% endif %}">
              <td><strong>{{ city.city }}</strong><br><small>{{ city.region }}</small></td>
              <td>{{ city.population }}</td>
              <td>
                {% if city.economics.exists %}
                  {% with eco=city.economics.first %}
                    {{ eco.ndfl_total|floatformat:0 }}
                    {% if eco.unemployment_rate %}({{ eco.unemployment_rate }}% –±–µ–∑—Ä–∞–±.){% endif %}
                  {% endwith %}
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.schools }}{% else %}‚Äî{% endif %}</td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.gas_stations }}{% else %}‚Äî{% endif %}</td>
              <td>{% if city.infrastructure %}{{ city.infrastructure.bus_stops }}{% else %}‚Äî{% endif %}</td>
              <td class="fw-bold">{{ city.cached_index|floatformat:2 }}</td>
              <td>
                {% if city.cached_index >= 0.9 %}
                  <span class="badge bg-success">–í—ã—Å–æ–∫–∏–π</span>
                {% elif city.cached_index >= 0.6 %}
                  <span class="badge bg-warning text-dark">–°—Ä–µ–¥–Ω–∏–π</span>
                {% else %}
                  <span class="badge bg-danger">–ù–∏–∑–∫–∏–π</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="text-center mt-3">
    <button id="toggle-btn" class="btn btn-outline-primary">
      –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≥–æ—Ä–æ–¥–∞
    </button>
  </div>

  <script>
    document.getElementById('toggle-btn').addEventListener('click', function() {
      const fullList = document.getElementById('full-list');
      const topList = document.getElementById('top-list');
      const btn = this;

      if (fullList.style.display === 'none') {
        fullList.style.display = 'block';
        topList.style.display = 'none';
        btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–ø-20';
      } else {
        fullList.style.display = 'none';
        topList.style.display = 'block';
        btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –≥–æ—Ä–æ–¥–∞';
      }
    });
  </script>
  <div class="mt-3">
    <a href="{% url 'export_csv' %}" class="btn btn-success">
      üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    </a>
  </div>

{% else %}
  <div class="alert alert-warning">
    <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
    <p>–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ <a href="{% url 'admin:core_locality_changelist' %}">–∞–¥–º–∏–Ω–∫—É</a>.</p>
    <ul>
      <li>–°–æ–∑–¥–∞–π—Ç–µ –≥–æ—Ä–æ–¥</li>
      <li>–î–æ–±–∞–≤—å—Ç–µ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª–∞–¥–∫–∞ "Economic data")</li>
      <li>–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (–≤–∫–ª–∞–¥–∫–∞ "Infrastructure")</li>
    </ul>
  </div>
{% endif %}
{% endblock %}
